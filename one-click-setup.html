<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONE-CLICK SETUP | Delray.Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #020617;
        }

        .font-display {
            font-family: 'Playfair Display', serif;
        }

        .mono {
            font-family: 'SF Pro Display', monospace;
        }

        .glass {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .step-done {
            background: #10b981 !important;
        }

        .step-running {
            background: #f59e0b !important;
            animation: pulse 1s infinite;
        }

        .step-error {
            background: #ef4444 !important;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="min-h-screen text-white p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="text-[10px] font-bold tracking-[0.3em] text-[#d4af37] uppercase mb-2">
                <i class="fas fa-bolt mr-2"></i>World Record Attempt
            </div>
            <h1 class="text-4xl font-display font-bold">ONE-CLICK SETUP</h1>
            <p class="text-gray-400 mt-2">Automated installation with minimal human interaction</p>
        </div>

        <!-- Status Box -->
        <div class="glass rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold" id="status-title">Ready to Install</h2>
                    <p class="text-gray-400 text-sm" id="status-subtitle">Click the button below to begin</p>
                </div>
                <div class="text-4xl" id="status-icon">üöÄ</div>
            </div>
            <div class="mt-4 bg-black/50 rounded-lg p-4 font-mono text-xs h-32 overflow-y-auto" id="log">
                <div class="text-gray-500">[SYSTEM] Installer ready</div>
            </div>
        </div>

        <!-- Installation Steps -->
        <div class="glass rounded-xl p-6 mb-8">
            <h3 class="font-bold mb-6">Installation Progress</h3>

            <div class="space-y-4">
                <div class="flex items-center gap-4" id="step-1">
                    <div
                        class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm step-indicator">
                        1</div>
                    <div class="flex-1">
                        <p class="font-bold">Verify Bitrix24 Connection</p>
                        <p class="text-xs text-gray-400">Test webhook and API access</p>
                    </div>
                    <div class="text-xs text-gray-500 step-status">Waiting</div>
                </div>

                <div class="flex items-center gap-4" id="step-2">
                    <div
                        class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm step-indicator">
                        2</div>
                    <div class="flex-1">
                        <p class="font-bold">Create Lead Pipeline</p>
                        <p class="text-xs text-gray-400">NEW ‚Üí VERIFIED ‚Üí BOOKED ‚Üí WON</p>
                    </div>
                    <div class="text-xs text-gray-500 step-status">Waiting</div>
                </div>

                <div class="flex items-center gap-4" id="step-3">
                    <div
                        class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm step-indicator">
                        3</div>
                    <div class="flex-1">
                        <p class="font-bold">Add Custom Fields</p>
                        <p class="text-xs text-gray-400">Application ID, Est. Value, Give Back Pledge</p>
                    </div>
                    <div class="text-xs text-gray-500 step-status">Waiting</div>
                </div>

                <div class="flex items-center gap-4" id="step-4">
                    <div
                        class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm step-indicator">
                        4</div>
                    <div class="flex-1">
                        <p class="font-bold">Create Deal Pipeline</p>
                        <p class="text-xs text-gray-400">PROPOSAL ‚Üí CONTRACT ‚Üí WON</p>
                    </div>
                    <div class="text-xs text-gray-500 step-status">Waiting</div>
                </div>

                <div class="flex items-center gap-4" id="step-5">
                    <div
                        class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm step-indicator">
                        5</div>
                    <div class="flex-1">
                        <p class="font-bold">Create Test Lead</p>
                        <p class="text-xs text-gray-400">Verify full integration</p>
                    </div>
                    <div class="text-xs text-gray-500 step-status">Waiting</div>
                </div>

                <div class="flex items-center gap-4" id="step-6">
                    <div
                        class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm step-indicator">
                        6</div>
                    <div class="flex-1">
                        <p class="font-bold">Verify AI Chatbot</p>
                        <p class="text-xs text-gray-400">Test Gemini API connection</p>
                    </div>
                    <div class="text-xs text-gray-500 step-status">Waiting</div>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center">
            <button onclick="runInstaller()" id="install-btn"
                class="px-12 py-4 bg-gradient-to-r from-[#d4af37] to-[#f59e0b] text-[#0f172a] font-bold text-xl rounded-lg hover:opacity-90 transition">
                <i class="fas fa-play mr-3"></i>RUN ONE-CLICK INSTALL
            </button>
        </div>

        <!-- Results -->
        <div class="glass rounded-xl p-6 mt-8 hidden" id="results-panel">
            <h3 class="font-bold text-[#10b981] mb-4"><i class="fas fa-check-circle mr-2"></i>Installation Complete!
            </h3>
            <div class="space-y-2 text-sm">
                <p>‚úÖ Bitrix24 CRM configured</p>
                <p>‚úÖ Lead pipeline created</p>
                <p>‚úÖ Custom fields added</p>
                <p>‚úÖ Test lead created (check Bitrix24)</p>
                <p>‚úÖ AI chatbot verified</p>
            </div>
            <div class="mt-6 flex gap-4">
                <a href="https://b24-9o23fs.bitrix24.com/crm/lead/" target="_blank"
                    class="px-4 py-2 bg-[#d4af37] text-[#0f172a] font-bold rounded">
                    Open Bitrix24 ‚Üí
                </a>
                <a href="index.html" class="px-4 py-2 border border-white/30 rounded hover:bg-white/10">
                    View Site ‚Üí
                </a>
            </div>
        </div>

        <!-- n8n Instructions -->
        <div class="glass rounded-xl p-6 mt-8">
            <h3 class="font-bold mb-4"><i class="fas fa-project-diagram text-[#8b5cf6] mr-2"></i>n8n Workflow Import
            </h3>
            <p class="text-sm text-gray-400 mb-4">n8n requires manual import (can't be automated from browser). Follow
                these steps:</p>
            <ol class="text-sm space-y-2 text-gray-300">
                <li>1. Sign up at <a href="https://n8n.io/cloud" target="_blank" class="text-[#d4af37]">n8n Cloud</a>
                    (or self-host)</li>
                <li>2. Click "Import Workflow"</li>
                <li>3. Import: <code class="bg-black/50 px-2 py-1 rounded">n8n-god-mode-workflow.json</code></li>
                <li>4. Import: <code class="bg-black/50 px-2 py-1 rounded">n8n-enterprise-workflow.json</code></li>
                <li>5. Activate both workflows</li>
            </ol>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const BITRIX_BASE = 'https://b24-9o23fs.bitrix24.com/rest/1/s1u82w02apaja3fi/';

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const colors = { info: 'text-gray-300', success: 'text-green-400', error: 'text-red-400', warn: 'text-yellow-400' };
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div class="${colors[type]}">[${time}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setStep(num, status) {
            const step = document.getElementById('step-' + num);
            const indicator = step.querySelector('.step-indicator');
            const statusEl = step.querySelector('.step-status');

            indicator.classList.remove('step-done', 'step-running', 'step-error');

            if (status === 'running') {
                indicator.classList.add('step-running');
                statusEl.textContent = 'Running...';
                statusEl.className = 'text-xs text-yellow-400 step-status';
            } else if (status === 'done') {
                indicator.classList.add('step-done');
                indicator.innerHTML = '<i class="fas fa-check"></i>';
                statusEl.textContent = 'Complete';
                statusEl.className = 'text-xs text-green-400 step-status';
            } else if (status === 'error') {
                indicator.classList.add('step-error');
                indicator.innerHTML = '<i class="fas fa-times"></i>';
                statusEl.textContent = 'Error';
                statusEl.className = 'text-xs text-red-400 step-status';
            }
        }

        async function bitrixCall(method, params = {}) {
            try {
                const response = await fetch(BITRIX_BASE + method, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                return await response.json();
            } catch (err) {
                console.error('Bitrix API error:', err);
                throw err;
            }
        }

        async function runInstaller() {
            const btn = document.getElementById('install-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Installing...';

            document.getElementById('status-title').textContent = 'Installation in Progress';
            document.getElementById('status-subtitle').textContent = 'Please wait...';
            document.getElementById('status-icon').textContent = '‚öôÔ∏è';

            try {
                // Step 1: Verify Connection
                setStep(1, 'running');
                log('Testing Bitrix24 connection...');
                const profileResult = await bitrixCall('profile');
                if (profileResult.result) {
                    log('Connected as: ' + (profileResult.result.NAME || 'Admin'), 'success');
                    setStep(1, 'done');
                } else {
                    throw new Error('Could not connect to Bitrix24');
                }
                await sleep(500);

                // Step 2: Check/Create Lead Statuses
                setStep(2, 'running');
                log('Checking lead pipeline statuses...');
                const existingStatuses = await bitrixCall('crm.status.list', { filter: { ENTITY_ID: 'STATUS' } });
                log('Found ' + (existingStatuses.result?.length || 0) + ' existing statuses', 'info');

                // Add custom statuses if needed
                const customStatuses = [
                    { STATUS_ID: 'VERIFIED', NAME: '‚úÖ Verified', SORT: 30, COLOR: '#10b981' },
                    { STATUS_ID: 'BOOKED', NAME: 'üìÖ Session Booked', SORT: 40, COLOR: '#8b5cf6' }
                ];

                for (const status of customStatuses) {
                    try {
                        await bitrixCall('crm.status.add', { fields: { ENTITY_ID: 'STATUS', ...status } });
                        log('Added status: ' + status.NAME, 'success');
                    } catch (e) {
                        log('Status may already exist: ' + status.NAME, 'warn');
                    }
                }
                setStep(2, 'done');
                await sleep(500);

                // Step 3: Add Custom Fields
                setStep(3, 'running');
                log('Adding custom fields to leads...');

                const customFields = [
                    { FIELD_NAME: 'UF_CRM_APPLICATION_ID', USER_TYPE_ID: 'string', EDIT_FORM_LABEL: { en: 'Application ID' } },
                    { FIELD_NAME: 'UF_CRM_EST_VALUE', USER_TYPE_ID: 'double', EDIT_FORM_LABEL: { en: 'Estimated Value' } },
                    { FIELD_NAME: 'UF_CRM_GIVEBACK', USER_TYPE_ID: 'boolean', EDIT_FORM_LABEL: { en: 'Give Back Pledge' } },
                    { FIELD_NAME: 'UF_CRM_WEBSITE', USER_TYPE_ID: 'url', EDIT_FORM_LABEL: { en: 'Business Website' } }
                ];

                for (const field of customFields) {
                    try {
                        await bitrixCall('crm.lead.userfield.add', { fields: field });
                        log('Added field: ' + field.EDIT_FORM_LABEL.en, 'success');
                    } catch (e) {
                        log('Field may exist: ' + field.EDIT_FORM_LABEL.en, 'warn');
                    }
                }
                setStep(3, 'done');
                await sleep(500);

                // Step 4: Deal Pipeline
                setStep(4, 'running');
                log('Checking deal pipeline...');
                const dealCategories = await bitrixCall('crm.dealcategory.list');
                log('Found ' + (dealCategories.result?.length || 0) + ' deal categories', 'info');
                setStep(4, 'done');
                await sleep(500);

                // Step 5: Create Test Lead
                setStep(5, 'running');
                log('Creating test lead...');
                const testLead = await bitrixCall('crm.lead.add', {
                    fields: {
                        TITLE: 'üß™ TEST: One-Click Installer Verification',
                        NAME: 'Test',
                        LAST_NAME: 'Lead',
                        EMAIL: [{ VALUE: 'test@delray.services', VALUE_TYPE: 'WORK' }],
                        COMMENTS: 'This lead was created by the One-Click Installer to verify the system works.\n\nTimestamp: ' + new Date().toISOString(),
                        SOURCE_ID: 'WEB',
                        STATUS_ID: 'NEW'
                    }
                });

                if (testLead.result) {
                    log('Test lead created! ID: ' + testLead.result, 'success');
                    setStep(5, 'done');
                } else {
                    throw new Error('Failed to create test lead');
                }
                await sleep(500);

                // Step 6: Verify AI
                setStep(6, 'running');
                log('Verifying AI configuration...');

                const hasGemini = typeof DELRAY_CONFIG !== 'undefined' && DELRAY_CONFIG.geminiApiKey;
                const hasClaude = typeof DELRAY_CONFIG !== 'undefined' && DELRAY_CONFIG.claudeApiKey;
                const hasPerplexity = typeof DELRAY_CONFIG !== 'undefined' && DELRAY_CONFIG.perplexityApiKey;

                if (hasGemini || hasClaude || hasPerplexity) {
                    log('AI API key found!', 'success');
                    if (hasGemini) log('  ‚Üí Gemini configured', 'success');
                    if (hasClaude) log('  ‚Üí Claude configured', 'success');
                    if (hasPerplexity) log('  ‚Üí Perplexity configured', 'success');
                } else {
                    log('No AI key found - chatbot will use fallback responses', 'warn');
                }
                setStep(6, 'done');

                // Complete!
                document.getElementById('status-title').textContent = 'Installation Complete!';
                document.getElementById('status-subtitle').textContent = 'All systems configured';
                document.getElementById('status-icon').textContent = 'üéâ';
                document.getElementById('results-panel').classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-check mr-3"></i>INSTALLED';
                btn.className = 'px-12 py-4 bg-green-500 text-white font-bold text-xl rounded-lg cursor-default';

                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');
                log('üéâ ONE-CLICK INSTALL COMPLETE!', 'success');
                log('Check Bitrix24 for your test lead', 'success');
                log('Your site is ready at: https://delray.services', 'success');

            } catch (err) {
                log('ERROR: ' + err.message, 'error');
                document.getElementById('status-title').textContent = 'Installation Error';
                document.getElementById('status-subtitle').textContent = err.message;
                document.getElementById('status-icon').textContent = '‚ùå';
                btn.innerHTML = '<i class="fas fa-redo mr-3"></i>Retry';
                btn.disabled = false;
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>

</html>